# AIDetector Backend

è¿™æ˜¯ä¸€ä¸ªåŸºäº **FastAPI** + **PostgreSQL** æ„å»ºçš„ AI å†…å®¹æ£€æµ‹åç«¯æœåŠ¡ã€‚å®ƒä½œä¸ºä¸šåŠ¡ç½‘å…³ï¼Œç®¡ç†ç”¨æˆ·è®¤è¯ã€API Keyã€å›¢é˜Ÿåä½œï¼Œå¹¶å°†å…·ä½“çš„æ£€æµ‹è¯·æ±‚è½¬å‘ç»™åº•å±‚çš„ **RepreGuard** å¾®æœåŠ¡è¿›è¡Œæ¨ç†ã€‚

> âš ï¸ **å¼€å‘çŠ¶æ€è¯´æ˜ (Development Status)**
> * **åç«¯æ¥å£**ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆè®¤è¯ã€æ£€æµ‹ã€API Keyã€å›¢é˜Ÿç®¡ç†ï¼‰å·²å®ç°ï¼Œéƒ¨åˆ†é«˜çº§ç®¡ç†æ¥å£ä»åœ¨å¼€å‘ä¸­ã€‚
> * **å‰ç«¯å¯¹æ¥**ï¼šç›®å‰åç«¯æœåŠ¡**æš‚æœªä¸å‰ç«¯é¡µé¢æ‰“é€š**ï¼Œè¯·ä½¿ç”¨ API å·¥å…·ï¼ˆå¦‚ Postmanï¼‰æˆ–ä¸‹æ–¹çš„ PowerShell è„šæœ¬è¿›è¡Œæµ‹è¯•ã€‚
> * **å¤–éƒ¨ä¾èµ–**ï¼šæ£€æµ‹åŠŸèƒ½å¼ºä¾èµ–äº `RepreGuard` å¾®æœåŠ¡ï¼Œè¯·ç¡®ä¿è¯¥æœåŠ¡å·²å¯åŠ¨ï¼Œå¦åˆ™ `/detect` æ¥å£ä¼šæŠ¥é”™ã€‚

## âœ¨ å·²å®ç°çš„æ ¸å¿ƒåŠŸèƒ½

* âœ… **å¤šæ–¹å¼é‰´æƒ**ï¼šæ”¯æŒ JWT (Bearer Token) å’Œ API Key (`X-API-Key`)ã€‚
* âœ… **AI æ£€æµ‹é›†æˆ**ï¼šå¯¹æ¥ RepreGuard å¾®æœåŠ¡ï¼ŒåŒ…å«è‡ªåŠ¨é‡è¯•ä¸åˆ†æ•°å½’ä¸€åŒ–ã€‚
* âœ… **ç”¨æˆ·ä½“ç³»**ï¼šæ³¨å†Œã€ç™»å½•ã€ä¸ªäººä¿¡æ¯æŸ¥è¯¢ã€‚
* âœ… **å›¢é˜Ÿåä½œ**ï¼šåˆ›å»ºå›¢é˜Ÿã€æ·»åŠ æˆå‘˜ã€æŸ¥çœ‹å›¢é˜Ÿç»´åº¦çš„æ£€æµ‹ç»Ÿè®¡ã€‚
* âœ… **å†å²è®°å½•**ï¼šæ£€æµ‹è®°å½•æŒä¹…åŒ–å­˜å‚¨ï¼Œæ”¯æŒæŒ‰æ—¶é—´ç­›é€‰ä¸åˆ†é¡µã€‚
* âœ… **æŒ‰æ—¥å­—ç¬¦é¢åº¦ (MVP)**ï¼šGuest 5000 å­—ç¬¦/å¤©ï¼Œç™»å½•ç”¨æˆ· 30000 å­—ç¬¦/å¤©ï¼Œè¶…é¢è¿”å› 429ã€‚
* ğŸš§ **ç³»ç»Ÿç®¡ç†**ï¼šåŸºç¡€çš„ç®¡ç†å‘˜çŠ¶æ€æ£€æŸ¥ï¼ˆé«˜çº§ç®¡ç†é¢æ¿å¼€å‘ä¸­ï¼‰ã€‚

## ğŸ›  å‰ç½®ä¾èµ–

åœ¨å¯åŠ¨æœ¬é¡¹ç›®ä¹‹å‰ï¼Œè¯·ç¡®ä¿ç¯å¢ƒæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š

1.  **Docker & Docker Compose**
2.  **RepreGuard æ£€æµ‹å¾®æœåŠ¡**ï¼ˆå…³é”®ï¼‰ï¼š
    * æœ¬é¡¹ç›®é»˜è®¤è¿æ¥ `http://host.docker.internal:9000`ã€‚
    * è‹¥ä¸å¯åŠ¨æ­¤å¾®æœåŠ¡ï¼Œè°ƒç”¨ `/detect` æ¥å£å°†è¿”å› `502 Bad Gateway`ã€‚
    * *é…ç½®ä¿®æ”¹ï¼šåœ¨ `.env` ä¸­è°ƒæ•´ `DETECT_SERVICE_URL`ã€‚*

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ç¤ºä¾‹é…ç½®æ–‡ä»¶ï¼š

```bash
cp .env.example .env
```

å»ºè®®ä¿®æ”¹ `.env` ä¸­çš„ä»¥ä¸‹é…ç½®ï¼š

* `SECRET_KEY`: ç”Ÿæˆ JWT çš„å¯†é’¥ã€‚
* `POSTGRES_PASSWORD`: æ•°æ®åº“å¯†ç ã€‚

### 2. å¯åŠ¨æœåŠ¡ (Docker Compose)

ä½¿ç”¨ Docker Compose ä¸€é”®æ„å»ºå¹¶å¯åŠ¨ API å’Œ æ•°æ®åº“æœåŠ¡ï¼š

```bash
docker compose up -d --build
```

### 3. æ‰§è¡Œæ•°æ®åº“è¿ç§»

é¦–æ¬¡å¯åŠ¨**å¿…é¡»**æ‰§è¡Œæ­¤å‘½ä»¤ä»¥åˆ›å»ºæ•°æ®è¡¨ï¼š

```bash
docker compose exec api alembic upgrade head
```

å¦‚éœ€ç”Ÿæˆæ–°çš„è¿ç§»æ–‡ä»¶ï¼ˆæ¨¡å‹å˜æ›´åï¼‰ï¼š

```bash
docker compose exec api alembic revision --autogenerate -m "describe changes"
```

---

## ğŸ§ª å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯• (PowerShell)

ä¸ºäº†æ–¹ä¾¿æµ‹è¯•äººå‘˜éªŒè¯åç«¯é€»è¾‘æ˜¯å¦è·‘é€šï¼Œè¿™é‡Œæä¾›äº†ä¸€å¥—å®Œæ•´çš„ **PowerShell** æŒ‡ä»¤ã€‚
æ‚¨å¯ä»¥æŒ‰é¡ºåºåœ¨ PowerShell ç»ˆç«¯ä¸­æ‰§è¡Œä»¥ä¸‹ä»£ç å—ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨ä¿å­˜ Token å’Œ API Key ä¾›åç»­æ­¥éª¤ä½¿ç”¨ã€‚

### 1. åŸºç¡€ç¯å¢ƒæ£€æŸ¥

ç¡®ä¿æœåŠ¡å·²å¯åŠ¨ä¸”æ•°æ®åº“è¿æ¥æ­£å¸¸ã€‚

```powershell
$BaseUrl = "http://localhost:8000/api/v1"

# 1. æœåŠ¡å¥åº·æ£€æŸ¥
Write-Host "--- 1. Health Check ---"
Invoke-RestMethod -Uri "$BaseUrl/health" -Method Get
# é¢„æœŸè¾“å‡º: status=ok

# 2. æ•°æ®åº“è¿æ¥æ£€æŸ¥
Write-Host "--- 2. DB Ping ---"
Invoke-RestMethod -Uri "$BaseUrl/db/ping" -Method Get
# é¢„æœŸè¾“å‡º: status=ok
```

### 2. ç”¨æˆ·è®¤è¯æµç¨‹

æ³¨å†Œä¸€ä¸ªæ–°ç”¨æˆ·å¹¶ç™»å½•è·å– Tokenã€‚

```powershell
# 3. æ³¨å†Œæ–°ç”¨æˆ·
Write-Host "--- 3. Register User ---"
$UserEmail = "test_user_$(Get-Random)@example.com"
$Body = @{ email = $UserEmail; name = "PS Test $(Get-Random)"; password = "StrongPass!23" } | ConvertTo-Json
try {
    Invoke-RestMethod -Uri "$BaseUrl/auth/register" -Method Post -Body $Body -ContentType "application/json"
    Write-Host "ç”¨æˆ· $UserEmail æ³¨å†ŒæˆåŠŸ" -ForegroundColor Green
} catch {
    Write-Host "ç”¨æˆ·å¯èƒ½å·²å­˜åœ¨ï¼Œå°è¯•ç›´æ¥ç™»å½•..." -ForegroundColor Yellow
}

# 4. ç™»å½•å¹¶ä¿å­˜ Token
Write-Host "--- 4. Login ---"
try {
    $LoginBody = @{ identifier = $UserEmail; password = "StrongPass!23" } | ConvertTo-Json
    $LoginResponse = Invoke-RestMethod -Uri "$BaseUrl/auth/login" -Method Post -Body $LoginBody -ContentType "application/json"
    $Token = $LoginResponse.access_token
    $Headers = @{ Authorization = "Bearer $Token" }
    Write-Host "Token è·å–æˆåŠŸ" -ForegroundColor Green
} catch {
    Write-Host "ç™»å½•å¤±è´¥: $($_.Exception.Message)" -ForegroundColor Red
}

# 5. éªŒè¯ Token (è·å–ä¸ªäººä¿¡æ¯)
Write-Host "--- 5. Get My Info ---"
Invoke-RestMethod -Uri "$BaseUrl/auth/me" -Method Get -Headers $Headers
```

### 3. AI æ£€æµ‹æµç¨‹ (æ ¸å¿ƒåŠŸèƒ½)

æµ‹è¯•æ–‡æœ¬æ£€æµ‹åŠŸèƒ½ã€‚**æ³¨æ„ï¼šéœ€ç¡®ä¿åº•å±‚çš„ RepreGuard æœåŠ¡å·²è¿è¡Œã€‚**

```powershell
# 6. å‘èµ·æ£€æµ‹è¯·æ±‚ (ä½¿ç”¨ Bearer Token)
Write-Host "--- 6. Detect Text (Bearer Token) ---"
$DetectBody = @{ text = "This is a sample text generated by AI to test the detector." } | ConvertTo-Json

try {
    $DetectResult = Invoke-RestMethod -Uri "$BaseUrl/detect" -Method Post -Headers $Headers -Body $DetectBody -ContentType "application/json"
    Write-Host "æ£€æµ‹æˆåŠŸ! Label: $($DetectResult.label) | Score: $($DetectResult.score)" -ForegroundColor Green
    Write-Host "åº•å±‚æ¨¡å‹: $($DetectResult.model_name)"
} catch {
    $StatusCode = $_.Exception.Response.StatusCode.value__
    Write-Host "æ£€æµ‹å¤±è´¥ (HTTP $StatusCode)" -ForegroundColor Red
    if ($StatusCode -eq 502) {
        Write-Host "åŸå› : æ— æ³•è¿æ¥ RepreGuard å¾®æœåŠ¡ï¼Œè¯·æ£€æŸ¥ host.docker.internal:9000 æ˜¯å¦å¯è¾¾" -ForegroundColor Yellow
    }
}
```

> â„¹ï¸ **é¢åº¦æé†’**ï¼š/detect ç°åœ¨æŒ‰æ—¥å­—ç¬¦é¢åº¦é™åˆ¶ï¼ˆGuest 5000ã€User 30000ï¼‰ã€‚è‹¥è¶…é¢ä¼šè¿”å› 429ï¼ˆcode=QUOTA_EXCEEDEDï¼‰ã€‚

### 4. API Key ç®¡ç†ä¸è°ƒç”¨

æ¨¡æ‹Ÿç¬¬ä¸‰æ–¹é€šè¿‡ API Key è°ƒç”¨æ¥å£çš„åœºæ™¯ã€‚

```powershell
# 7. åˆ›å»º API Key
Write-Host "--- 7. Create API Key ---"
$KeyBody = @{ name = "Test Key PowerShell" } | ConvertTo-Json
$KeyResponse = Invoke-RestMethod -Uri "$BaseUrl/keys" -Method Post -Headers $Headers -Body $KeyBody -ContentType "application/json"
$ApiKey = $KeyResponse.key
Write-Host "API Key åˆ›å»ºæˆåŠŸ: $ApiKey" -ForegroundColor Green

# 8. ä½¿ç”¨ API Key è¿›è¡Œæ£€æµ‹ (æ— éœ€ Bearer Token)
Write-Host "--- 8. Detect Text (X-API-Key) ---"
$KeyHeaders = @{ "X-API-Key" = $ApiKey }
try {
    $KeyDetectResult = Invoke-RestMethod -Uri "$BaseUrl/detect" -Method Post -Headers $KeyHeaders -Body $DetectBody -ContentType "application/json"
    Write-Host "API Key æ£€æµ‹æˆåŠŸ! Label: $($KeyDetectResult.label)" -ForegroundColor Green
} catch {
    Write-Host "API Key æ£€æµ‹å¤±è´¥: $($_.Exception.Message)" -ForegroundColor Red
}
```

### 5. å›¢é˜Ÿä¸æ•°æ®ç»Ÿè®¡

æµ‹è¯•å›¢é˜Ÿåä½œåŠŸèƒ½ã€‚

```powershell
# 9. åˆ›å»ºå›¢é˜Ÿ
Write-Host "--- 9. Create Team ---"
$TeamBody = @{ name = "Dev Team $(Get-Random)" } | ConvertTo-Json
try {
    $Team = Invoke-RestMethod -Uri "$BaseUrl/teams" -Method Post -Headers $Headers -Body $TeamBody -ContentType "application/json"
    Write-Host "å›¢é˜Ÿåˆ›å»ºæˆåŠŸ ID: $($Team.id)" -ForegroundColor Green
    
    # 10. æŸ¥çœ‹å›¢é˜Ÿç»Ÿè®¡
    Write-Host "--- 10. Team Stats ---"
    $Stats = Invoke-RestMethod -Uri "$BaseUrl/teams/$($Team.id)/stats" -Method Get -Headers $Headers
    Write-Host "ç»Ÿè®¡æ•°æ® (Items):"
    $Stats.items | Format-Table date, detections
} catch {
    Write-Host "å›¢é˜Ÿæ“ä½œå¤±è´¥: $($_.Exception.Message)" -ForegroundColor Red
}
```

### 6. æŸ¥çœ‹å†å²è®°å½•

ç¡®è®¤ä¹‹å‰çš„æ£€æµ‹æ“ä½œå‡å·²è½åº“ã€‚

```powershell
# 11. åˆ†é¡µæŸ¥è¯¢æ£€æµ‹å†å²
Write-Host "--- 11. History ---"
$History = Invoke-RestMethod -Uri "$BaseUrl/detections?page=1&page_size=5" -Method Get -Headers $Headers
Write-Host "å…±æ‰¾åˆ° $($History.total) æ¡è®°å½•"
$History.items | Select-Object id, label, score, created_at | Format-Table
```

---

## âœ… é¢åº¦ä¸ Guest / User è‡ªæµ‹è„šæœ¬ (PowerShell)

ä»¥ä¸‹è„šæœ¬ä»…æ–°å¢éƒ¨åˆ†ï¼Œä¸å½±å“ä¸Šé¢çš„å®Œæ•´æµç¨‹ã€‚

### 7.1 Guest æµ‹è¯•

```powershell
# 1. è·å– guest token
Write-Host "--- 12. Guest Token ---"
$GuestResp = Invoke-RestMethod -Uri "$BaseUrl/auth/guest" -Method Post
$GuestToken = $GuestResp.access_token
$GuestHeaders = @{ Authorization = "Bearer $GuestToken" }

# 2. æŸ¥è¯¢ quotaï¼ˆGuest limit=5000ï¼‰
Write-Host "--- 13. Guest Quota ---"
$GuestQuota = Invoke-RestMethod -Uri "$BaseUrl/quota" -Method Get -Headers $GuestHeaders
$GuestQuota | Format-Table

# 3. ä½¿ç”¨ guest token å‘èµ·æ£€æµ‹ï¼ˆçŸ­æ–‡æœ¬åº”æˆåŠŸï¼‰
Write-Host "--- 14. Guest Detect ---"
$GuestDetectBody = @{ text = "Guest short text." } | ConvertTo-Json
Invoke-RestMethod -Uri "$BaseUrl/detect" -Method Post -Headers $GuestHeaders -Body $GuestDetectBody -ContentType "application/json"

# 4. æ„é€ è¶…é•¿æ–‡æœ¬è§¦å‘ 429
Write-Host "--- 15. Guest Detect Over Quota ---"
$Remaining = [Math]::Max($GuestQuota.remaining, 0)
$LongText = ("A" * ($Remaining + 10))
$GuestOverBody = @{ text = $LongText } | ConvertTo-Json
try {
    Invoke-RestMethod -Uri "$BaseUrl/detect" -Method Post -Headers $GuestHeaders -Body $GuestOverBody -ContentType "application/json"
} catch {
    Write-Host "é¢„æœŸ 429 QUOTA_EXCEEDED: $($_.Exception.Message)" -ForegroundColor Yellow
}
```

### 7.2 User æµ‹è¯•

```powershell
# 1. å¤ç”¨ä¸Šé¢çš„æ³¨å†Œ/ç™»å½•æ­¥éª¤è·å– $Headers

# 2. æŸ¥è¯¢ quotaï¼ˆUser limit=30000ï¼‰
Write-Host "--- 16. User Quota ---"
$UserQuota = Invoke-RestMethod -Uri "$BaseUrl/quota" -Method Get -Headers $Headers
$UserQuota | Format-Table

# 3. ä½¿ç”¨ user token å‘èµ·æ£€æµ‹ï¼ˆçŸ­æ–‡æœ¬åº”æˆåŠŸï¼‰
Write-Host "--- 17. User Detect ---"
$UserDetectBody = @{ text = "User short text." } | ConvertTo-Json
Invoke-RestMethod -Uri "$BaseUrl/detect" -Method Post -Headers $Headers -Body $UserDetectBody -ContentType "application/json"

# 4. æ„é€ è¶…é•¿æ–‡æœ¬è§¦å‘ 429
Write-Host "--- 18. User Detect Over Quota ---"
$UserRemaining = [Math]::Max($UserQuota.remaining, 0)
$UserLongText = ("A" * ($UserRemaining + 10))
$UserOverBody = @{ text = $UserLongText } | ConvertTo-Json
try {
    Invoke-RestMethod -Uri "$BaseUrl/detect" -Method Post -Headers $Headers -Body $UserOverBody -ContentType "application/json"
} catch {
    Write-Host "é¢„æœŸ 429 QUOTA_EXCEEDED: $($_.Exception.Message)" -ForegroundColor Yellow
}
```

## ğŸ“‚ ç›®å½•ç»“æ„è¯´æ˜

```
backend/
â”œâ”€â”€ alembic/             # æ•°æ®åº“è¿ç§»è„šæœ¬
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/v1/          # API è·¯ç”±å®ç°
â”‚   â”‚   â”œâ”€â”€ auth.py      # è®¤è¯ (ç™»å½•/æ³¨å†Œ)
â”‚   â”‚   â”œâ”€â”€ detections.py# æ£€æµ‹é€»è¾‘ (æ ¸å¿ƒ)
â”‚   â”‚   â”œâ”€â”€ keys.py      # API Key ç®¡ç†
â”‚   â”‚   â””â”€â”€ teams.py     # å›¢é˜Ÿç®¡ç†
â”‚   â”œâ”€â”€ core/            # æ ¸å¿ƒé…ç½® (config, security)
â”‚   â”œâ”€â”€ models/          # æ•°æ®åº“æ¨¡å‹ (User, Detection, Team)
â”‚   â””â”€â”€ services/        # ä¸šåŠ¡æœåŠ¡å±‚
â”‚       â””â”€â”€ repre_guard_client.py # ä¸ AI å¾®æœåŠ¡é€šä¿¡çš„å®¢æˆ·ç«¯
â””â”€â”€ tests/               # å•å…ƒæµ‹è¯•
```

## ğŸ”Œ å¸¸è§é—®é¢˜ (FAQ)

**Q: æ‰§è¡Œ `/detect` æ—¶æŠ¥é”™ `502 Bad Gateway`ï¼Ÿ**
A: è¿™æ˜¯å› ä¸ºåç«¯è¿æ¥ä¸ä¸Š AI æ£€æµ‹å¾®æœåŠ¡ã€‚

1. è¯·æ£€æŸ¥ `docker-compose.yml` æˆ– `.env` ä¸­çš„ `DETECT_SERVICE_URL` é…ç½®ã€‚
2. ç¡®ä¿æ‚¨å·²ç»åœ¨æœ¬åœ°æˆ–æœåŠ¡å™¨ä¸Šå¯åŠ¨äº†æä¾› `/detect` æ¥å£çš„æ¨¡å‹æœåŠ¡ã€‚

**Q: æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Ÿ**
A: è¯·ç¡®ä¿ Docker å®¹å™¨ `db` æ­£åœ¨è¿è¡Œï¼Œä¸” `POSTGRES_PASSWORD` ä¸ `.env` æ–‡ä»¶ä¸€è‡´ã€‚

**Q: å¦‚ä½•é‡ç½®æ•°æ®åº“ï¼Ÿ**
A: `docker compose down -v` (è¿™ä¼šåˆ é™¤æ‰€æœ‰æ•°æ®)ï¼Œç„¶åé‡æ–° `up` å¹¶æ‰§è¡Œ `alembic upgrade head`ã€‚
